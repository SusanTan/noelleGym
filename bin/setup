#!/bin/bash -e

prefixString="### NOELLE Gym: Setup ###" ;
echo "${prefixString} All benchmarks from all benchmark suites will be compiled" ;
echo "${prefixString} Results will be stored in `pwd`/results/current_machine" ;
echo "${prefixString} The output of each step will be stored in `pwd`/output.txt" ;
echo "${prefixString}     (you can run \"tail -f output.txt\" to see the current state at finer granularity)" ;
echo "" ;

origDir="`pwd`" ;

# Test the environment
if ! command -v go &> /dev/null; then
  echo "\"go\" cannot be found. Please enable a go installation. If you are in Zythos, run the following command:" ;
  echo "  source /project/go/go_1.13.7/enable" ;
  exit 1;
fi

# Compile NOELLE
echo "${prefixString} Start compiling NOELLE" ;
./scripts/compile_NOELLE.sh >> ${origDir}/output.txt 2>&1 ;
echo "${prefixString}   NOELLE has been compiled succesfully" ;

# Download the git repository
echo "${prefixString} Setup the benchmark suites" ;
if ! test -d all_benchmark_suites ; then
  git clone https://github.com/scampanoni/wholeprogram_benchmarks.git all_benchmark_suites >> ${origDir}/output.txt 2>&1 ;
fi
cd all_benchmark_suites ;
if ! test -e install ; then
  echo "${prefixString}   Compile" ;
  make >> ${origDir}/output.txt 2>&1 ;
fi
